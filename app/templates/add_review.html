{% extends "base.html" %} 

{% block content %}
<div class="max-w-2xl mx-auto">
  <div class="mb-12">
    <h1 class="text-3xl font-bold text-white tracking-tighter uppercase mb-2">Новая запись</h1>
    <div class="h-1 w-12 bg-white"></div>
  </div>

  <div class="mb-10 bg-zinc-950 border border-zinc-800 p-6">
    <label class="block text-[10px] uppercase tracking-[0.2em] text-zinc-500 mb-3">Умный поиск (Google Books)</label>
    <div class="flex space-x-2">
      <input type="text" id="search_input" placeholder="ВВЕДИТЕ НАЗВАНИЕ..." class="flex-grow bg-black border border-zinc-800 p-3 text-xs text-white focus:border-zinc-500 outline-none transition tracking-widest uppercase" />
      <button type="button" onclick="searchBook()" id="search_btn" class="bg-zinc-100 text-black px-6 py-3 text-[10px] font-black uppercase tracking-widest hover:bg-white transition flex items-center justify-center min-w-[100px]">Найти</button>
    </div>
    <p class="text-[9px] text-zinc-600 mt-3 uppercase tracking-wider italic">* Автоматическое заполнение полей</p>
  </div>

  <form action="/add" method="post" class="space-y-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div>
        <label class="block text-[10px] uppercase tracking-[0.2em] text-zinc-500 mb-2">Название</label>
        <input type="text" name="book_title" required class="w-full bg-black border-b border-zinc-800 p-2 text-white focus:border-white outline-none transition text-sm" />
      </div>
      <div>
        <label class="block text-[10px] uppercase tracking-[0.2em] text-zinc-500 mb-2">Автор</label>
        <input type="text" name="author" required class="w-full bg-black border-b border-zinc-800 p-2 text-white focus:border-white outline-none transition text-sm" />
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div>
        <label class="block text-[10px] uppercase tracking-[0.2em] text-zinc-500 mb-2">Оценка (1-10)</label>
        <input type="number" name="rating" min="1" max="10" required class="w-full bg-black border-b border-zinc-800 p-2 text-white focus:border-white outline-none transition text-sm" />
      </div>
      <div>
        <label class="block text-[10px] uppercase tracking-[0.2em] text-zinc-500 mb-2">Статус</label>
        <select name="status" class="w-full bg-black border-b border-zinc-800 p-2 text-zinc-400 text-[10px] uppercase tracking-widest outline-none focus:border-white">
          <option value="Прочитано">Прочитано</option>
          <option value="Читаю сейчас">Читаю сейчас</option>
          <option value="В планах">В планах</option>
        </select>
      </div>
    </div>

    <input type="hidden" name="cover_url" value="https://placehold.co/400x600/18181b/ffffff?text=NO+COVER" />
    <textarea name="description" class="hidden"></textarea>

    <div>
      <label class="block text-[10px] uppercase tracking-[0.2em] text-zinc-500 mb-2">Текст рецензии</label>
      <textarea name="text" rows="8" required class="w-full bg-zinc-950 border border-zinc-800 p-4 text-white focus:border-zinc-600 outline-none transition text-sm leading-relaxed"></textarea>
    </div>

    <button type="submit" class="w-full bg-white text-black py-4 text-[10px] font-black uppercase tracking-[0.3em] hover:bg-zinc-200 transition shadow-2xl shadow-white/5">Опубликовать</button>
  </form>
</div>

<script>
  async function searchBook() {
    const titleInput = document.getElementById("search_input");
    const btn = document.getElementById("search_btn");
    const title = titleInput.value;
    if (!title) { alert("ВВЕДИТЕ НАЗВАНИЕ КНИГИ"); return; }

    const originalText = btn.innerText;
    btn.innerText = "ПОИСК...";
    btn.disabled = true;
    btn.classList.add("opacity-50", "cursor-not-allowed");

    try {
      const response = await fetch(`/search?title=${encodeURIComponent(title)}`);
      const data = await response.json();

      if (data.error) {
        alert("КНИГА НЕ НАЙДЕНА. ВВЕДИТЕ ДАННЫЕ ВРУЧНУЮ.");
      } else {
        document.getElementsByName("book_title")[0].value = data.title;
        document.getElementsByName("author")[0].value = data.author;

        let finalCover = data.cover_url;
        if (!finalCover) {
          finalCover = "https://placehold.co/400x600/18181b/ffffff?text=NO+COVER";
          alert("Обложка не найдена. Установлена стандартная картинка.");
        }
        document.getElementsByName("cover_url")[0].value = finalCover;
        document.getElementsByName("description")[0].value = data.description;
      }
    } catch (e) {
      console.error("Ошибка:", e);
      alert("ОШИБКА ПРИ ПОДКЛЮЧЕНИИ К СЕРВЕРУ");
    } finally {
      btn.innerText = originalText;
      btn.disabled = false;
      btn.classList.remove("opacity-50", "cursor-not-allowed");
    }
  }
</script>
{% endblock %}